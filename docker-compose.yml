# ===========================================
# Ecolive Website - Docker Compose
# ===========================================
#
# Database: usa vps-panel-postgres esistente
# Storage: usa vps-panel-minio esistente
# Routing: Traefik con SSL (Docker labels)
#

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ecolive-website_app
    restart: unless-stopped
    env_file:
      - .env.docker
    environment:
      - NODE_ENV=production
    networks:
      - traefik-public
      - panel-internal
    labels:
      # Traefik routing
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # Production router (www.ecolive.srl + ecolive.srl + preview)
      - "traefik.http.routers.ecolive.rule=Host(`www.ecolive.srl`) || Host(`ecolive.srl`) || Host(`ecolive.fodivps2.cloud`) || Host(`ecolive-website.fodivps2.cloud`)"
      - "traefik.http.routers.ecolive.entrypoints=websecure"
      - "traefik.http.routers.ecolive.tls.certresolver=letsencrypt"
      - "traefik.http.routers.ecolive.middlewares=ecolive-security-headers"
      - "traefik.http.routers.ecolive.service=ecolive"

      # Service
      - "traefik.http.services.ecolive.loadbalancer.server.port=3000"

      # Custom middleware: security headers with Sketchfab CSP
      - "traefik.http.middlewares.ecolive-security-headers.headers.frameDeny=false"
      - "traefik.http.middlewares.ecolive-security-headers.headers.sslRedirect=true"
      - "traefik.http.middlewares.ecolive-security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.ecolive-security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.ecolive-security-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.ecolive-security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.ecolive-security-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.ecolive-security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.ecolive-security-headers.headers.customFrameOptionsValue=SAMEORIGIN"
      - "traefik.http.middlewares.ecolive-security-headers.headers.contentSecurityPolicy=default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; frame-src 'self' https://sketchfab.com https://superspl.at; connect-src 'self' https://api.fodivps2.cloud wss://fodivps2.cloud wss://api.fodivps2.cloud; worker-src 'self' blob:; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"
      - "traefik.http.middlewares.ecolive-security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.ecolive-security-headers.headers.permissionsPolicy=camera=(), microphone=(), geolocation=(), payment=()"

      # www-redirect middleware (ecolive.srl â†’ www.ecolive.srl)
      # Note: handled at DNS level via Cloudflare, Docker label redirect optional

      # Metadata per VPS Panel
      - "com.docker.compose.project=ecolive-website"
      - "vps.project.slug=ecolive-website"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  traefik-public:
    external: true
  panel-internal:
    external: true
